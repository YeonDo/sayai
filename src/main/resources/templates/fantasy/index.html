<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Fantasy League - Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/fantasy.css}">
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <div class="fantasy-header">
            <h1>KBO Fantasy League</h1>
        </div>

        <div th:replace="fragments/fantasy-nav :: nav(active='main')"></div>

        <div id="games-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            <!-- JS will populate -->
            <p>Loading games...</p>
        </div>
    </div>

    <!-- Game Details Modal -->
    <div id="gameDetailsModal" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto;">
        <div class="modal-container" style="background: white; padding: 20px; border-radius: 8px; width: 1000px; max-width: 95%; margin: 50px auto; position: relative; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="border-bottom: 1px solid #eee; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 1.5rem;">Game Details: <span id="detailTitle" style="color: #002561;"></span></h2>
                <button onclick="closeDetailsModal()" style="background:none; border:none; font-size: 2rem; cursor: pointer;">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Rules Section -->
                <div class="details-section">
                    <h3>Rules & Scoring</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <p><strong>드래프트룰:</strong> <span id="detailRule"></span></p>
                            <p><strong>배점 방식:</strong> <span id="detailScoring"></span></p>
                            <p><strong>상태:</strong> <span id="detailStatus"></span></p>
                            <p><strong>드래프트 시간:</strong> <span id="detailTimeLimit"></span></p>
                            <p><strong>대회 기간:</strong> <span id="detailDuration"></span></p>
                            <p id="detailOptions" style="margin-top:10px;"></p>
                        </div>
                        <div>
                            <p><strong>배점 방식:</strong></p>
                            <div id="detailScoringSettings" style="background: #f9f9f9; padding: 10px; border-radius: 4px; font-size: 0.9rem; max-height: 100px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <p style="margin-top: 10px; color: #666; font-style: italic;">
                        <br> 1. ㄹ 자 드래프트로 18인 픽 (타자 9 / 투수 9) </br>
                        <br> 2. 배점 방식: 한주간 성적의 종합으로 순위 매김 (로티세리 룰) </br>
                        <br> 3. 선수단 성적 별로 타자 5개 종목, 투수 5개 종목의 순위에 따라 점수를 받아서 4주간 총점이 높은자가 우승 </br>
                        <br> 4. 타자부문 타율 홈런 타점 삼진 도루 </br>
                        <br> 투수부문 다승 탈삼진 세이브 방어율 whip </br>
                        <br> 5. 드래프트 Rule_2의 경우 1차 지명 룰이 존재 (응원팀의 선수만 1라운드 픽 가능) </br>
                    </p>
                </div>

                <!-- Rosters Section -->
                <div class="details-section" style="border-bottom: none;">
                    <h3>Participant Rosters</h3>
                    <div id="rosterTabs" class="tabs-header">
                        <!-- Tabs generated here -->
                    </div>

                    <div id="rosterContent" class="my-team-container" style="display:none;">
                        <!-- Field View (Copied Structure) -->
                        <div class="fantasy-card">
                            <h4 class="card-title">Fielding & Batting</h4>
                            <div class="baseball-field" id="detailField">
                                <div class="field-position pos-c" id="d-slot-C"><span class="pos-label">C</span><span class="player-name">-</span></div>
                                <div class="field-position pos-1b" id="d-slot-1B"><span class="pos-label">1B</span><span class="player-name">-</span></div>
                                <div class="field-position pos-2b" id="d-slot-2B"><span class="pos-label">2B</span><span class="player-name">-</span></div>
                                <div class="field-position pos-3b" id="d-slot-3B"><span class="pos-label">3B</span><span class="player-name">-</span></div>
                                <div class="field-position pos-ss" id="d-slot-SS"><span class="pos-label">SS</span><span class="player-name">-</span></div>
                                <div class="field-position pos-lf" id="d-slot-LF"><span class="pos-label">LF</span><span class="player-name">-</span></div>
                                <div class="field-position pos-cf" id="d-slot-CF"><span class="pos-label">CF</span><span class="player-name">-</span></div>
                                <div class="field-position pos-rf" id="d-slot-RF"><span class="pos-label">RF</span><span class="player-name">-</span></div>
                                <div class="field-position pos-dh" id="d-slot-DH"><span class="pos-label">DH</span><span class="player-name">-</span></div>
                            </div>
                        </div>

                        <!-- Pitching View -->
                        <div class="fantasy-card">
                            <h4 class="card-title">Pitching Staff</h4>
                            <div class="pitcher-list">
                                <div class="pitcher-slot" id="d-slot-SP-1"><span class="pitcher-role">SP</span><span class="player-name">-</span></div>
                                <div class="pitcher-slot" id="d-slot-SP-2"><span class="pitcher-role">SP</span><span class="player-name">-</span></div>
                                <div class="pitcher-slot" id="d-slot-SP-3"><span class="pitcher-role">SP</span><span class="player-name">-</span></div>
                                <div class="pitcher-slot" id="d-slot-SP-4"><span class="pitcher-role">SP</span><span class="player-name">-</span></div>
                                <div class="pitcher-slot" id="d-slot-RP-1"><span class="pitcher-role">RP</span><span class="player-name">-</span></div>
                                <div class="pitcher-slot" id="d-slot-RP-2"><span class="pitcher-role">RP</span><span class="player-name">-</span></div>
                                <div class="pitcher-slot" id="d-slot-RP-3"><span class="pitcher-role">RP</span><span class="player-name">-</span></div>
                                <div class="pitcher-slot" id="d-slot-RP-4"><span class="pitcher-role">RP</span><span class="player-name">-</span></div>
                                <div class="pitcher-slot" id="d-slot-CL-1"><span class="pitcher-role">CP</span><span class="player-name">-</span></div>
                            </div>
                        </div>
                    </div>
                    <div id="rosterEmptyMsg" style="text-align:center; padding: 30px; display:none;">
                        No roster data available.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Modal -->
    <div id="joinModal" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-container" style="background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; margin: 100px auto; position: relative;">
            <div class="modal-header" style="border-bottom: 1px solid #eee; margin-bottom: 15px; display: flex; justify-content: space-between;">
                <h3 style="margin: 0;">Join Fantasy League</h3>
                <button onclick="closeJoinModal()" style="background:none; border:none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;"><strong>Rule Type:</strong> <span id="modalRuleDesc"></span></p>
                <form id="joinForm">
                    <input type="hidden" id="joinGameSeq">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom: 5px; font-weight: bold;">팀명</label>
                        <input type="text" id="joinTeamName" class="form-control" required placeholder="Enter your fantasy team name" style="width: 100%; padding: 8px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom: 5px; font-weight: bold;">응원팀을 고르세요</label>
                        <select id="joinPrefTeam" class="form-control" style="width: 100%; padding: 8px;">
                            <option value="KIA">KIA 타이거즈</option>
                            <option value="삼성">삼성 라이온즈</option>
                            <option value="LG">LG 트윈스</option>
                            <option value="두산">두산 베어스</option>
                            <option value="KT">KT 위즈</option>
                            <option value="SSG">SSG 랜더스</option>
                            <option value="롯데">롯데 자이언츠</option>
                            <option value="한화">한화 이글스</option>
                            <option value="NC">NC 다이노스</option>
                            <option value="키움">키움 히어로즈</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 10px;">참가하기</button>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function() {
            loadGames();

            $('#joinForm').submit(function(e) {
                e.preventDefault();
                const seq = $('#joinGameSeq').val();
                const data = {
                    preferredTeam: $('#joinPrefTeam').val(),
                    teamName: $('#joinTeamName').val()
                };

                $.ajax({
                    url: '/apis/v1/fantasy/games/' + seq + '/join',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function() {
                        alert('Joined successfully!');
                        closeJoinModal();
                        loadGames();
                    },
                    error: function(xhr) {
                        alert('Join failed: ' + (xhr.responseText || 'Error'));
                    }
                });
            });
        });

        function loadGames() {
            $.get('/apis/v1/fantasy/games', function(games) {
                const container = $('#games-container');
                container.empty();

                if (games.length === 0) {
                    container.html('<p style="grid-column: 1 / -1; text-align: center; font-size: 1.2rem; margin-top: 50px;">현재 진행 중인 경기가 없습니다</p>');
                    return;
                }

                games.forEach(game => {
                    let actionBtn = '';
                    if (game.joined) {
                        if (game.status === 'DRAFTING') {
                            // DRAFTING -> Active Link
                            actionBtn = `<a href="/fantasy/draft/${game.seq}" class="status-badge status-${game.status}" style="display:block; text-align:center; padding: 10px; text-decoration:none;">${game.status} (Enter Draft Room)</a>`;
                        } else {
                            // WAITING, ONGOING, FINISHED -> Status Text only
                            actionBtn = `<span class="status-badge status-${game.status}" style="display:block; text-align:center; padding: 10px;">${game.status} (Joined: ${game.myTeamName})</span>`;
                        }
                    } else if (game.status === 'WAITING') {
                        // Not Joined, Waiting -> Show Join Button
                        // Pass JSON string to onClick
                        const gameJson = JSON.stringify(game).replace(/"/g, '&quot;');
                        actionBtn = `<button class="btn btn-primary" style="width:100%" onclick="openJoinModal(${game.seq}, '${game.ruleType}')">Participate</button>`;
                    } else {
                        // Not Joined, Not Waiting -> Show Status
                        actionBtn = `<span class="status-badge status-${game.status}" style="display:block; text-align:center; padding: 10px;">${game.status}</span>`;
                    }

                    const card = `
                        <div class="fantasy-card" style="border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: #fff;">
                            <h3 style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 10px;">${game.title}</h3>
                            <p><strong>드래프트룰:</strong> ${game.ruleType}</p>
                            <p><strong>배점 방식:</strong> ${game.scoringType}</p>
                            <div style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;">
                                ${game.useFirstPickRule ? '<span class="status-badge" style="background:#002561; font-size:0.7rem;">1차지명</span>' : ''}
                                ${game.useTeamRestriction ? '<span class="status-badge" style="background:#d32f2f; font-size:0.7rem;">팀제한</span>' : ''}
                                ${game.salaryCap ? `<span class="status-badge" style="background:#2e7d32; font-size:0.7rem;">Salary: ${game.salaryCap}</span>` : ''}
                            </div>
                            <p><strong>참가자수:</strong> ${game.participantCount} / ${game.maxParticipants || 'Unlim.'}</p>
                            <p><strong>드래프트 시간:</strong> ${game.draftTimeLimit ? game.draftTimeLimit + '분' : '제한없음'}</p>
                            <p><strong>드래프트 일정:</strong> ${game.draftDate ? new Date(game.draftDate).toLocaleString() : 'TBD'}</p>
                            <p><strong>대회 일정:</strong> ${game.gameDuration || 'TBD'}</p>
                            <div style="margin-top: 15px;">
                                ${actionBtn}
                                <button class="btn btn-secondary" style="width:100%; margin-top:5px; background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;" onclick="openDetailsModal(${game.seq})">Details</button>
                            </div>
                        </div>
                    `;
                    container.append(card);
                });
            });
        }

        let currentGameDetails = null;

        function openDetailsModal(gameSeq) {
            $('#gameDetailsModal').css('display', 'flex');
            // Reset
            $('#detailTitle').text('Loading...');
            $('#rosterTabs').empty();
            $('#rosterContent').hide();
            $('#rosterEmptyMsg').hide();

            $.get(`/apis/v1/fantasy/games/${gameSeq}/details`, function(data) {
                currentGameDetails = data;

                // Populate Info
                $('#detailTitle').text(data.title);
                $('#detailRule').text(data.ruleType);
                $('#detailScoring').text(data.scoringType);
                $('#detailStatus').text(data.status);
                $('#detailTimeLimit').text(data.draftTimeLimit ? data.draftTimeLimit + '분' : '제한없음');
                $('#detailDuration').text(data.gameDuration || 'TBD');
                $('#detailScoringSettings').text(data.scoringSettings || 'Default Settings');

                // Populate Options
                let optionsHtml = '';
                if(data.useFirstPickRule) optionsHtml += '<span class="status-badge" style="background:#002561; margin-right:5px;">1차지명</span>';
                if(data.useTeamRestriction) optionsHtml += '<span class="status-badge" style="background:#d32f2f; margin-right:5px;">팀제한</span>';
                if(data.salaryCap) optionsHtml += `<span class="status-badge" style="background:#2e7d32; margin-right:5px;">Salary: ${data.salaryCap}</span>`;
                $('#detailOptions').html(optionsHtml);

                // Generate Tabs
                const tabsContainer = $('#rosterTabs');
                tabsContainer.empty();

                if (!data.participants || data.participants.length === 0) {
                    tabsContainer.html('<span style="color:#666; padding:10px;">No participants yet.</span>');
                    return;
                }

                data.participants.forEach((p, index) => {
                    const btn = $(`<button class="tab-btn" onclick="selectRosterTab(${index})">${p.teamName}</button>`);
                    tabsContainer.append(btn);
                });

                // Select first tab
                if (data.participants.length > 0) {
                    selectRosterTab(0);
                }
            });
        }

        function closeDetailsModal() {
            $('#gameDetailsModal').hide();
        }

        function selectRosterTab(index) {
            if (!currentGameDetails || !currentGameDetails.participants[index]) return;

            // Update Active State
            $('.tab-btn').removeClass('active');
            $('.tab-btn').eq(index).addClass('active');

            const participant = currentGameDetails.participants[index];
            renderDetailRoster(participant.roster);
        }

        function renderDetailRoster(roster) {
            // Reset Fields
            $('#detailField .player-name').text('-');
            $('#detailField .player-team').remove();
            $('#gameDetailsModal .pitcher-slot').removeClass('filled').find('.player-name').text('-');

            $('#rosterContent').show();
            $('#rosterEmptyMsg').hide();

            if (!roster || roster.length === 0) {
                // Show empty roster message? Or just empty field
                return;
            }

            const filledSlots = {};
            const spCount = { count: 1 };
            const rpCount = { count: 1 };

            roster.forEach(p => {
                const positions = p.position.split(',').map(s => s.trim());
                let assigned = false;

                // 1. Primary
                for (const pos of positions) {
                    if (isPitcher(pos)) continue;
                    if (!filledSlots[pos]) {
                        fillDetailSlot(pos, p);
                        filledSlots[pos] = true;
                        assigned = true;
                        break;
                    }
                }

                // 2. DH
                if (!assigned && !isPitcher(positions[0])) {
                    if (!filledSlots['DH']) {
                        fillDetailSlot('DH', p);
                        filledSlots['DH'] = true;
                        assigned = true;
                    }
                }

                // 3. Pitchers
                if (!assigned && isPitcher(positions[0])) {
                     if (positions.includes('SP')) {
                         assignDetailPitcher('SP', spCount, p);
                     } else if (positions.includes('RP')) {
                         assignDetailPitcher('RP', rpCount, p);
                     } else if (positions.includes('CL') || positions.includes('CP')) {
                         if (!filledSlots['CL']) {
                             fillDetailPitcherSlot('CL-1', p);
                             filledSlots['CL'] = true;
                         }
                     }
                }
            });
        }

        function isPitcher(pos) {
            return ['SP', 'RP', 'CP', 'CL'].includes(pos);
        }

        function fillDetailSlot(pos, player) {
            const slot = $(`#d-slot-${pos}`);
            if (slot.length) {
                slot.find('.player-name').text(player.name);
                slot.append(`<span class="player-team" style="display:block; font-size:0.8rem; color:#666;">${player.team}</span>`);
            }
        }

        function assignDetailPitcher(type, counterObj, player) {
            if (counterObj.count <= 4) {
                fillDetailPitcherSlot(`${type}-${counterObj.count}`, player);
                counterObj.count++;
            }
        }

        function fillDetailPitcherSlot(idSuffix, player) {
            const slot = $(`#d-slot-${idSuffix}`);
            if (slot.length) {
                slot.addClass('filled');
                slot.find('.player-name').text(`${player.name} (${player.team})`);
            }
        }

        function openJoinModal(seq, ruleType) {
            $('#joinGameSeq').val(seq);
            $('#modalRuleDesc').text(ruleType);
            $('#joinModal').css('display', 'flex'); // Flex to center
        }

        function closeJoinModal() {
            $('#joinModal').hide();
        }
        /*]]>*/
    </script>
</div>
</body>
</html>
