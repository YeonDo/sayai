<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Fantasy League - Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/fantasy.css}">
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <div class="fantasy-header">
            <h1>KBO Fantasy League</h1>
        </div>

        <div th:replace="fragments/fantasy-nav :: nav(active='main')"></div>

        <div id="games-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            <!-- JS will populate -->
            <p>Loading games...</p>
        </div>
    </div>

    <!-- Join Modal -->
    <div id="joinModal" class="modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-container" style="background: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; margin: 100px auto; position: relative;">
            <div class="modal-header" style="border-bottom: 1px solid #eee; margin-bottom: 15px; display: flex; justify-content: space-between;">
                <h3 style="margin: 0;">Join Fantasy League</h3>
                <button onclick="closeJoinModal()" style="background:none; border:none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;"><strong>Rule Type:</strong> <span id="modalRuleDesc"></span></p>
                <form id="joinForm">
                    <input type="hidden" id="joinGameSeq">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom: 5px; font-weight: bold;">My Team Name</label>
                        <input type="text" id="joinTeamName" class="form-control" required placeholder="Enter your fantasy team name" style="width: 100%; padding: 8px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom: 5px; font-weight: bold;">Preferred KBO Team</label>
                        <select id="joinPrefTeam" class="form-control" style="width: 100%; padding: 8px;">
                            <option value="KIA">KIA Tigers</option>
                            <option value="SAMSUNG">Samsung Lions</option>
                            <option value="LG">LG Twins</option>
                            <option value="DOOSAN">Doosan Bears</option>
                            <option value="KT">KT Wiz</option>
                            <option value="SSG">SSG Landers</option>
                            <option value="LOTTE">Lotte Giants</option>
                            <option value="HANWHA">Hanwha Eagles</option>
                            <option value="NC">NC Dinos</option>
                            <option value="KIWOOM">Kiwoom Heroes</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 10px;">Join League</button>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // Simple Auth context - in real app, fetched from session or API
        const currentUserId = 1; // Simulation: Default to 1. In real world, API should handle auth context implicitly.

        $(document).ready(function() {
            loadGames();

            $('#joinForm').submit(function(e) {
                e.preventDefault();
                const seq = $('#joinGameSeq').val();
                const data = {
                    playerId: currentUserId, // Backend might override with principal if configured
                    preferredTeam: $('#joinPrefTeam').val(),
                    teamName: $('#joinTeamName').val()
                };

                $.ajax({
                    url: '/apis/v1/fantasy/games/' + seq + '/join',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function() {
                        alert('Joined successfully!');
                        closeJoinModal();
                        loadGames();
                    },
                    error: function(xhr) {
                        alert('Join failed: ' + (xhr.responseText || 'Error'));
                    }
                });
            });
        });

        function loadGames() {
            $.get('/apis/v1/fantasy/games?userId=' + currentUserId, function(games) {
                const container = $('#games-container');
                container.empty();

                if (games.length === 0) {
                    container.html('<p style="grid-column: 1 / -1; text-align: center; font-size: 1.2rem; margin-top: 50px;">현재 진행 중인 경기가 없습니다</p>');
                    return;
                }

                games.forEach(game => {
                    let actionBtn = '';
                    if (game.joined) {
                        // Already Joined -> Show Status
                        actionBtn = `<span class="status-badge status-${game.status}" style="display:block; text-align:center; padding: 10px;">${game.status} (Joined: ${game.myTeamName})</span>`;
                    } else if (game.status === 'WAITING') {
                        // Not Joined, Waiting -> Show Join Button
                        // Pass JSON string to onClick
                        const gameJson = JSON.stringify(game).replace(/"/g, '&quot;');
                        actionBtn = `<button class="btn btn-primary" style="width:100%" onclick="openJoinModal(${game.seq}, '${game.ruleType}')">Participate</button>`;
                    } else {
                        // Not Joined, Not Waiting -> Show Status
                        actionBtn = `<span class="status-badge status-${game.status}" style="display:block; text-align:center; padding: 10px;">${game.status}</span>`;
                    }

                    const card = `
                        <div class="fantasy-card" style="border: 1px solid #ddd; padding: 20px; border-radius: 8px; background: #fff;">
                            <h3 style="margin-top:0; border-bottom: 2px solid #eee; padding-bottom: 10px;">${game.title}</h3>
                            <p><strong>Rule:</strong> ${game.ruleType}</p>
                            <p><strong>Scoring:</strong> ${game.scoringType}</p>
                            <p><strong>Participants:</strong> ${game.participantCount} / ${game.maxParticipants || 'Unlim.'}</p>
                            <p><strong>Draft Date:</strong> ${game.draftDate ? new Date(game.draftDate).toLocaleString() : 'TBD'}</p>
                            <div style="margin-top: 15px;">
                                ${actionBtn}
                            </div>
                        </div>
                    `;
                    container.append(card);
                });
            });
        }

        window.openJoinModal = function(seq, ruleType) {
            $('#joinGameSeq').val(seq);
            $('#modalRuleDesc').text(ruleType);
            $('#joinModal').css('display', 'flex'); // Flex to center
        };

        window.closeJoinModal = function() {
            $('#joinModal').hide();
        };
        /*]]>*/
    </script>
</div>
</body>
</html>
