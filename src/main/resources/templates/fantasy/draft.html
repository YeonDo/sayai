<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Fantasy League - Draft Room</title>
    <link rel="stylesheet" th:href="@{/css/fantasy.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .draft-order-strip {
            display: flex;
            overflow-x: auto;
            background: #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            gap: 10px;
        }
        .draft-participant {
            padding: 5px 10px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            white-space: nowrap;
        }
        .draft-participant.active {
            background: #007bff;
            color: white;
            font-weight: bold;
            border-color: #0056b3;
        }
        .draft-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .timer { font-weight: bold; color: #d9534f; }
        .disabled-btn { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <header class="fantasy-header">
            <h1>Draft Room</h1>
            <span id="game-status" class="status-badge status-WAITING">Loading...</span>
        </header>

        <div th:replace="fragments/fantasy-nav :: nav(active='draft')"></div>

        <div id="draft-ui-container" style="display:none;">
            <div id="draft-order-strip" class="draft-order-strip"></div>
            <div class="draft-info-bar">
                <span>Round: <span id="current-round">-</span></span>
                <span>Turn: <strong id="current-turn-name">-</strong></span>
                <span>Time Left: <span id="timer" class="timer">--:--</span></span>
                <span id="salary-info" style="display:none; margin-left: 10px; font-weight: bold; color: #2e7d32;">Salary: <span id="current-cost">0</span> / <span id="salary-cap"></span></span>
            </div>
        </div>


        <!-- Mobile Tabs -->
        <div class="draft-mobile-tabs">
            <button class="draft-tab active" onclick="switchDraftTab('available')">선수 목록</button>
            <button class="draft-tab" onclick="switchDraftTab('mypicks')">My Picks</button>
        </div>

        <div class="draft-container">
            <!-- Available Players -->
            <div id="tab-available" class="fantasy-card draft-tab-content active">
                <h2 class="card-title">선수 목록</h2>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filter-team" style="padding: 5px;">
                        <option value="">모든 팀</option>
                        <option value="두산">두산 베어스</option>
                        <option value="LG">LG 트윈스</option>
                        <option value="KIA">KIA 타이거즈</option>
                        <option value="삼성">삼성 라이온즈</option>
                        <option value="롯데">롯데 자이언츠</option>
                        <option value="한화">한화 이글스</option>
                        <option value="NC">NC 다이노스</option>
                        <option value="KT">KT 위즈</option>
                        <option value="SSG">SSG 랜더스</option>
                        <option value="키움">키움 히어로즈</option>
                    </select>
                    <select id="filter-position" style="padding: 5px;">
                        <option value="">모든 포지션</option>
                        <option value="C">C</option>
                        <option value="1B">1B</option>
                        <option value="2B">2B</option>
                        <option value="3B">3B</option>
                        <option value="SS">SS</option>
                        <option value="LF">LF</option>
                        <option value="CF">CF</option>
                        <option value="RF">RF</option>
                        <option value="DH">DH</option>
                        <option value="SP">SP</option>
                        <option value="RP">RP</option>
                        <option value="CL">CL</option>
                    </select>
                    <select id="sort-order" style="padding: 5px;">
                        <option value="">기본 정렬</option>
                        <option value="cost_desc">Cost (High-Low)</option>
                        <option value="cost_asc">Cost (Low-High)</option>
                    </select>
                    <input type="text" id="search-player" placeholder="Search player..." style="padding: 5px; flex-grow: 1;">
                    <button class="btn-primary" onclick="loadAvailablePlayers()">검색</button>
                </div>
                <div class="table-responsive">
                <table class="fantasy-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Pos</th>
                            <th>Team</th>
                            <th>Stats</th>
                            <th>Cost</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="available-players-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                </div>
            </div>

            <!-- My Picks -->
            <div id="tab-mypicks" class="fantasy-card draft-tab-content">
                <h2 class="card-title">My Picks</h2>
                <ul id="my-picks-list" style="list-style: none; padding: 0;">
                    <!-- Populated by JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="hidden" id="gameSeq" th:value="${gameSeq}" />
    <input type="hidden" id="currentUserId" th:value="${currentUserId}" />

    <script th:inline="javascript">
        /*<![CDATA[*/
        const gameSeq = document.getElementById('gameSeq').value;
        const userId = document.getElementById('currentUserId').value;
        let stompClient = null;
        let isConnecting = false;

        // Game State
        let gameState = {
            status: 'WAITING',
            participants: [],
            nextPickerId: null,
            nextPickDeadline: null,
            ruleType: 'RULE_1',
            myPreferredTeam: null,
            round: 1, // Default
            salaryCap: null,
            currentCost: 0
        };

        // Client-side cache
        let allAvailablePlayers = [];
        let isPlayersLoaded = false;

        $(document).ready(function() {
            initGame();
            connectWebSocket();

            // Mobile sync: Refresh state when returning to tab
            document.addEventListener("visibilitychange", function() {
                if (document.visibilityState === 'visible') {
                    console.log("App resumed, syncing state...");
                    initGame();
                    connectWebSocket();
                }
            });

            $('#filter-team, #filter-position, #sort-order').change(function() {
                renderPlayers(); // Local filter
            });
            $('#search-player').on('keyup', function(e) {
                renderPlayers(); // Local search
            });

            setInterval(updateTimer, 1000);
        });

        function switchDraftTab(tabName) {
            // Only effective on mobile where tabs are shown
            $('.draft-tab').removeClass('active');
            $(`.draft-tab[onclick="switchDraftTab('${tabName}')"]`).addClass('active');

            // Hide all tab contents and show the selected one
            // Note: On desktop, CSS should override this to always show both
            $('.draft-tab-content').removeClass('active');
            $(`#tab-${tabName}`).addClass('active');
        }

        function initGame() {
            $.get(`/apis/v1/fantasy/games/${gameSeq}/details`, function(data) {
                gameState.status = data.status;
                gameState.participants = data.participants || [];
                gameState.nextPickerId = data.nextPickerId;
                gameState.nextPickDeadline = data.nextPickDeadline;
                gameState.ruleType = data.ruleType; // RULE_1 or RULE_2
                gameState.round = data.roundNum;
                gameState.salaryCap = data.salaryCap;

                // Determine My Info
                const myPart = gameState.participants.find(p => String(p.participantId) === String(userId));
                if (myPart) {
                    gameState.myPreferredTeam = myPart.preferredTeam;
                }

                if (gameState.salaryCap && gameState.salaryCap > 0) {
                    $('#salary-info').show();
                    $('#salary-cap').text(gameState.salaryCap);
                }

                updateUI();
                loadAvailablePlayers(true); // Force refresh on init/resume
                loadMyPicks();
            });
        }

        function updateUI() {
            // Update Status Badge
            $('#game-status').text(gameState.status).attr('class', 'status-badge status-' + gameState.status);

            // Show/Hide Admin Controls
            if (gameState.status === 'WAITING') {
                // Only show if element exists (admin only)
                if ($('#admin-controls').length) {
                   $('#admin-controls').show();
                }
                $('#draft-ui-container').hide();
            } else if (gameState.status === 'DRAFTING') {
                $('#admin-controls').hide();
                $('#draft-ui-container').show();
            } else {
                $('#admin-controls').hide();
                $('#draft-ui-container').hide();
            }

            renderOrderStrip();

            // Highlight Current Turn
            if (gameState.nextPickerId) {
                const picker = gameState.participants.find(p => p.participantId === gameState.nextPickerId);
                $('#current-turn-name').text(picker ? picker.teamName : 'Unknown');
                $('#current-round').text(gameState.round || '-');
            }
        }

        function renderOrderStrip() {
            const strip = $('#draft-order-strip');
            strip.empty();

            // Sort by draftOrder
            const sorted = [...gameState.participants].sort((a, b) => (a.draftOrder || 0) - (b.draftOrder || 0));

            sorted.forEach(p => {
                const isActive = (p.participantId === gameState.nextPickerId);
                strip.append(`
                    <div class="draft-participant ${isActive ? 'active' : ''}">
                        ${p.draftOrder}. ${p.teamName}
                    </div>
                `);
            });
        }

        function updateTimer() {
            if (gameState.status !== 'DRAFTING' || !gameState.nextPickDeadline) {
                $('#timer').text('--:--');
                return;
            }
            const now = new Date().getTime();
            const deadline = new Date(gameState.nextPickDeadline).getTime();
            const diff = deadline - now;

            if (diff <= 0) {
                $('#timer').text('00:00');
            } else {
                const min = Math.floor(diff / 60000);
                const sec = Math.floor((diff % 60000) / 1000);
                $('#timer').text(`${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`);
            }
        }


        function connectWebSocket() {
            if (isConnecting || (stompClient && stompClient.connected)) return;

            isConnecting = true;
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                isConnecting = false;
                stompClient.subscribe('/topic/draft/' + gameSeq, function(message) {
                    const event = JSON.parse(message.body);
                    handleDraftEvent(event);
                });
            }, function(error) {
                isConnecting = false;
                console.error('STOMP connection error:', error);
            });
        }

        function handleDraftEvent(event) {
            if (event.type === 'START') {
                gameState.status = 'DRAFTING';
                gameState.participants = event.draftOrder; // Update with ordered list
                gameState.nextPickerId = event.nextPickerId;
                gameState.nextPickDeadline = event.nextPickDeadline;
                gameState.round = event.round;
                updateUI();
                // Force reload full list on start to be safe
                loadAvailablePlayers(true);
            } else if (event.type === 'PICK') {
                gameState.nextPickerId = event.nextPickerId;
                gameState.nextPickDeadline = event.nextPickDeadline;
                gameState.round = event.round;

                // Optimistic Update: Remove player from local cache
                removePlayerFromCache(event.fantasyPlayerSeq);

                updateUI();
                renderPlayers(); // Re-render with updated state (turn change etc)

                if (String(event.playerId) === String(userId)) {
                    loadMyPicks();
                }
            } else if (event.type === 'FINISH') {
                gameState.status = 'FINISHED'; // Or ONGOING
                gameState.nextPickerId = null;
                gameState.nextPickDeadline = null;
                alert("Draft Completed!");

                removePlayerFromCache(event.fantasyPlayerSeq);

                updateUI();
                renderPlayers();
                if (String(event.playerId) === String(userId)) {
                    loadMyPicks();
                }
            }
        }

        function removePlayerFromCache(seq) {
            allAvailablePlayers = allAvailablePlayers.filter(p => p.seq !== seq);
        }

        // Fetch all players once (or force refresh)
        function loadAvailablePlayers(force = false) {
            if (isPlayersLoaded && !force) {
                renderPlayers();
                return;
            }

            // Fetch ALL players (no server-side filters)
            $.get(`/apis/v1/fantasy/games/${gameSeq}/available-players`, function(data) {
                allAvailablePlayers = data;
                isPlayersLoaded = true;
                renderPlayers();
            });
        }

        function renderPlayers() {
            const teamFilter = $('#filter-team').val();
            const posFilter = $('#filter-position').val();
            const searchText = $('#search-player').val().toLowerCase();
            const sortOrder = $('#sort-order').val();

            // Filter
            let filtered = allAvailablePlayers.filter(p => {
                if (teamFilter && p.team !== teamFilter) return false;
                if (posFilter) {
                    // Simple check: does position string contain it?
                    // Or exact match? Server was exact for 'C', LIKE for others.
                    // Let's implement robust check similar to server
                    if (posFilter === 'C') {
                        // Must be exactly C or start with C, but not CF/CL?
                        // Server logic: "C" -> exact "C".
                        // Client logic: p.position is "C" or "C, 1B".
                        const positions = p.position.split(',').map(s => s.trim());
                        if (!positions.includes('C')) return false;
                    } else {
                        if (!p.position.includes(posFilter)) return false;
                    }
                }
                if (searchText && !p.name.toLowerCase().includes(searchText)) return false;
                return true;
            });

            // Sort
            if (sortOrder === 'cost_desc') {
                filtered.sort((a, b) => (b.cost || 0) - (a.cost || 0));
            } else if (sortOrder === 'cost_asc') {
                filtered.sort((a, b) => (a.cost || 0) - (b.cost || 0));
            }

            const tbody = $('#available-players-body');
            tbody.empty();

            const isMyTurn = (String(gameState.nextPickerId) === String(userId));
            const isRound1 = (gameState.round === 1);

            // Limit render to improve performance (e.g. 100 items) if list is huge?
            // For KBO ~600 players, it's fine to render all or maybe top 100.
            const renderList = filtered.slice(0, 100);

            renderList.forEach(player => {
                const firstPos = player.position ? player.position.split(',')[0].trim().toLowerCase() : '';
                let cssClass = 'pos-' + firstPos;
                if(firstPos === 'cl') cssClass = 'pos-cl';

                let disabled = !isMyTurn;
                let btnText = "Draft";

                // Rule 2 Check
                if (isMyTurn && gameState.ruleType === 'RULE_2' && isRound1) {
                     // Check team
                     const myTeam = (gameState.myPreferredTeam || "").toLowerCase().trim();
                     const pTeam = (player.team || "").toLowerCase().trim();
                     if (myTeam && !pTeam.includes(myTeam) && !myTeam.includes(pTeam)) {
                         disabled = true;
                         btnText = "Restricted"; // Or just keep disabled
                     }
                }

                // First Pick Rule (Rule 1 Option) Check
                // We need to know if Rule 1 Option is enabled.
                // Currently gameState doesn't explicitly store useFirstPickRule flag but backend sends RuleType.
                // Assuming useFirstPickRule is property of game, we should fetch it in initGame.
                // But for now, let's skip strict client-side check if we lack the flag, server will block.
                // Or user can add the flag to initGame details.

                // Salary Cap Check
                if (isMyTurn && gameState.salaryCap && gameState.salaryCap > 0) {
                    const currentCost = gameState.currentCost || 0;
                    const playerCost = player.cost || 0;
                    if (currentCost + playerCost > gameState.salaryCap) {
                        disabled = true;
                        btnText = "Over Cap";
                    }
                }

                tbody.append(`
                    <tr>
                        <td>${player.name}</td>
                        <td><span class="position-badge ${cssClass}">${player.position}</span></td>
                        <td><span class="team-badge">${player.team}</span></td>
                        <td>${player.stats || '-'}</td>
                        <td>${player.cost || 0}</td>
                        <td>
                            <button class="btn-draft ${disabled ? 'disabled-btn' : ''}"
                                    onclick="draftPlayer(${player.seq})"
                                    ${disabled ? 'disabled' : ''}>
                                ${btnText}
                            </button>
                        </td>
                    </tr>
                `);
            });
        }

        function loadMyPicks() {
            $.get(`/apis/v1/fantasy/games/${gameSeq}/players/${userId}/picks`, function(data) {
                const list = $('#my-picks-list');
                list.empty();
                let totalCost = 0;
                data.forEach(player => {
                    const firstPos = player.position ? player.position.split(',')[0].trim().toLowerCase() : '';
                    let cssClass = 'pos-' + firstPos;
                    if(firstPos === 'cl') cssClass = 'pos-cl';
                    totalCost += (player.cost || 0);

                    list.append(`
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                            <strong>${player.name}</strong> <span class="position-badge ${cssClass}">${player.position}</span>
                            <span style="float:right; font-size:0.9rem; color:#666;">${player.cost || 0}</span>
                        </li>
                    `);
                });
                $('#current-cost').text(totalCost);
                gameState.currentCost = totalCost;
                // Reload available players to update Over Cap buttons if cost changed
                // Avoid infinite loop if calling from within init? init calls both.
                // But loadAvailablePlayers doesn't call loadMyPicks.
                // We call loadAvailablePlayers here to refresh buttons state
                loadAvailablePlayers();
            });
        }

        function draftPlayer(playerSeq) {
            const data = {
                fantasyGameSeq: gameSeq,
                playerId: userId,
                fantasyPlayerSeq: playerSeq
            };

            $.ajax({
                url: '/apis/v1/fantasy/draft',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    console.log("Draft request sent successfully");
                },
                error: function(xhr) {
                    alert('Draft 실패: ' + (xhr.responseText || 'Error'));
                }
            });
        }
        /*]]>*/
    </script>
</div>
</body>
</html>
