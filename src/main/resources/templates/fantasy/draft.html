<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy League - Draft Room</title>
    <link rel="stylesheet" th:href="@{/css/fantasy.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SockJS and Stomp -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <div class="fantasy-container">
        <header class="fantasy-header">
            <h1>Draft Room</h1>
            <span id="game-status" class="status-badge status-WAITING">Loading...</span>
        </header>

        <nav class="fantasy-nav">
            <a th:href="@{/fantasy}">Dashboard</a>
            <a th:href="@{/fantasy/my-team}">My Team</a>
            <a th:href="@{/fantasy/draft/1}" class="active">Draft Room</a>
            <a th:href="@{/fantasy/players}">Players</a>
            <a th:href="@{/fantasy/trade}">Trade</a>
            <a th:href="@{/fantasy/settings}">Settings</a>
        </nav>

        <div id="join-section" class="fantasy-card" style="display:none;">
            <h2 class="card-title">Join Game</h2>
            <p>Select your preferred team to join the draft.</p>
            <select id="preferred-team">
                <option value="Doosan">Doosan Bears</option>
                <option value="LG">LG Twins</option>
                <option value="Kia">Kia Tigers</option>
                <!-- Add other teams -->
            </select>
            <button class="btn-primary" onclick="joinGame()">Join Game</button>
        </div>

        <div class="draft-container">
            <div class="fantasy-card">
                <h2 class="card-title">Available Players</h2>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filter-team" style="padding: 5px;">
                        <option value="">All Teams</option>
                        <option value="Doosan">Doosan Bears</option>
                        <option value="LG">LG Twins</option>
                        <option value="Kia">Kia Tigers</option>
                        <option value="Samsung">Samsung Lions</option>
                        <option value="Lotte">Lotte Giants</option>
                        <option value="Hanwha">Hanwha Eagles</option>
                        <option value="NC">NC Dinos</option>
                        <option value="KT">KT Wiz</option>
                        <option value="SSG">SSG Landers</option>
                        <option value="Kiwoom">Kiwoom Heroes</option>
                    </select>
                    <select id="filter-position" style="padding: 5px;">
                        <option value="">All Positions</option>
                        <option value="C">C</option>
                        <option value="1B">1B</option>
                        <option value="2B">2B</option>
                        <option value="3B">3B</option>
                        <option value="SS">SS</option>
                        <option value="LF">LF</option>
                        <option value="CF">CF</option>
                        <option value="RF">RF</option>
                        <option value="DH">DH</option>
                        <option value="SP">SP</option>
                        <option value="RP">RP</option>
                        <option value="CL">CL</option>
                    </select>
                    <input type="text" id="search-player" placeholder="Search player..." style="padding: 5px; flex-grow: 1;">
                    <button class="btn-primary" onclick="loadAvailablePlayers()">Filter</button>
                </div>
                <table class="fantasy-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Pos</th>
                            <th>Team</th>
                            <th>Stats</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="available-players-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>

            <div class="fantasy-card">
                <h2 class="card-title">My Picks</h2>
                <ul id="my-picks-list" style="list-style: none; padding: 0;">
                    <!-- Populated by JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="hidden" id="gameSeq" th:value="${gameSeq}" />
    <input type="hidden" id="currentUserId" th:value="${currentUserId}" />

    <script>
        const gameSeq = document.getElementById('gameSeq').value;
        const userId = document.getElementById('currentUserId').value;
        let stompClient = null;

        $(document).ready(function() {
            connectWebSocket();
            loadAvailablePlayers();
            loadMyPicks();

            // Filter Change Events
            $('#filter-team, #filter-position').change(function() {
                loadAvailablePlayers();
            });
            $('#search-player').on('keyup', function(e) {
                if (e.key === 'Enter') loadAvailablePlayers();
            });

            // In a real app, poll status.
            $('#game-status').text('DRAFTING').removeClass('status-WAITING').addClass('status-DRAFTING'); // Mocking status for UI
        });

        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/draft/' + gameSeq, function(message) {
                    const event = JSON.parse(message.body);
                    handleDraftEvent(event);
                });
            });
        }

        function handleDraftEvent(event) {
            console.log("Draft Event:", event);

            // Notify User
            // Ideally, use a toast notification instead of alert to be less intrusive
            // alert(event.message);

            // Refresh available players (remove picked player locally for performance or reload)
            loadAvailablePlayers();

            // Refresh my picks if it was me
            if (String(event.playerId) === String(userId)) {
                loadMyPicks();
            }
        }

        function loadAvailablePlayers() {
            const team = $('#filter-team').val();
            const position = $('#filter-position').val();
            const search = $('#search-player').val();

            let query = `?`;
            if (team) query += `team=${encodeURIComponent(team)}&`;
            if (position) query += `position=${encodeURIComponent(position)}&`;
            if (search) query += `search=${encodeURIComponent(search)}&`;

            $.get(`/apis/v1/fantasy/games/${gameSeq}/available-players${query}`, function(data) {
                const tbody = $('#available-players-body');
                tbody.empty();
                data.forEach(player => {
                    tbody.append(`
                        <tr>
                            <td>${player.name}</td>
                            <td><span class="position-badge">${player.position}</span></td>
                            <td><span class="team-badge">${player.team}</span></td>
                            <td>${player.stats || '-'}</td>
                            <td><button class="btn-draft" onclick="draftPlayer(${player.seq})">Draft</button></td>
                        </tr>
                    `);
                });
            });
        }

        function loadMyPicks() {
            $.get(`/apis/v1/fantasy/games/${gameSeq}/players/${userId}/picks`, function(data) {
                const list = $('#my-picks-list');
                list.empty();
                data.forEach(player => {
                    list.append(`
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                            <strong>${player.name}</strong> <span class="position-badge">${player.position}</span>
                        </li>
                    `);
                });
            });
        }

        function draftPlayer(playerSeq) {
            const data = {
                fantasyGameSeq: gameSeq,
                playerId: userId,
                fantasyPlayerSeq: playerSeq
            };

            $.ajax({
                url: '/apis/v1/fantasy/draft',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    // Success handled via WebSocket event usually,
                    // but for immediate feedback we can keep alert or rely on UI update.
                    console.log("Draft request sent successfully");
                },
                error: function(xhr) {
                    alert('Draft Failed: ' + xhr.responseText);
                }
            });
        }

        function joinGame() {
            const team = $('#preferred-team').val();
            const data = {
                playerId: userId,
                preferredTeam: team
            };
             $.ajax({
                url: `/apis/v1/fantasy/games/${gameSeq}/join`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    alert('Joined Successfully!');
                    $('#join-section').hide();
                },
                error: function(xhr) {
                    alert('Join Failed: ' + xhr.responseText);
                }
            });
        }
    </script>
</body>
</html>
