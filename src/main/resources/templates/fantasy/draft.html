<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Fantasy League - Draft Room</title>
    <link rel="stylesheet" th:href="@{/css/fantasy.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <header class="fantasy-header">
            <h1>Draft Room</h1>
            <span id="game-status" class="status-badge status-WAITING">Loading...</span>
        </header>

        <div th:replace="fragments/fantasy-nav :: nav(active='draft')"></div>

        <div class="draft-container">
            <div class="fantasy-card">
                <h2 class="card-title">Available Players</h2>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filter-team" style="padding: 5px;">
                        <option value="">모든 팀</option>
                        <option value="두산">두산 베어스</option>
                        <option value="LG">LG 트윈스</option>
                        <option value="Kia">KIA 타이거즈</option>
                        <option value="삼성">삼성 라이온즈</option>
                        <option value="롯데">롯데 자이언츠</option>
                        <option value="한화">한화 이글스</option>
                        <option value="NC">NC 다이노스</option>
                        <option value="KT">KT 위즈</option>
                        <option value="SSG">SSG 랜더스</option>
                        <option value="키움">키움 히어로즈</option>
                    </select>
                    <select id="filter-position" style="padding: 5px;">
                        <option value="">모든 포지션</option>
                        <option value="C">C</option>
                        <option value="1B">1B</option>
                        <option value="2B">2B</option>
                        <option value="3B">3B</option>
                        <option value="SS">SS</option>
                        <option value="LF">LF</option>
                        <option value="CF">CF</option>
                        <option value="RF">RF</option>
                        <option value="DH">DH</option>
                        <option value="SP">SP</option>
                        <option value="RP">RP</option>
                        <option value="CL">CL</option>
                    </select>
                    <input type="text" id="search-player" placeholder="Search player..." style="padding: 5px; flex-grow: 1;">
                    <button class="btn-primary" onclick="loadAvailablePlayers()">검색</button>
                </div>
                <div class="table-responsive">
                <table class="fantasy-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Pos</th>
                            <th>Team</th>
                            <th>Stats</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="available-players-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                </div>
            </div>

            <div class="fantasy-card">
                <h2 class="card-title">My Picks</h2>
                <ul id="my-picks-list" style="list-style: none; padding: 0;">
                    <!-- Populated by JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="hidden" id="gameSeq" th:value="${gameSeq}" />
    <input type="hidden" id="currentUserId" th:value="${currentUserId}" />

    <script th:inline="javascript">
        /*<![CDATA[*/
        const gameSeq = document.getElementById('gameSeq').value;
        const userId = document.getElementById('currentUserId').value;
        let stompClient = null;

        $(document).ready(function() {
            connectWebSocket();
            loadAvailablePlayers();
            loadMyPicks();

            $('#filter-team, #filter-position').change(function() {
                loadAvailablePlayers();
            });
            $('#search-player').on('keyup', function(e) {
                if (e.key === 'Enter') loadAvailablePlayers();
            });

            $('#game-status').text('DRAFTING').removeClass('status-WAITING').addClass('status-DRAFTING');
        });

        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/draft/' + gameSeq, function(message) {
                    const event = JSON.parse(message.body);
                    handleDraftEvent(event);
                });
            });
        }

        function handleDraftEvent(event) {
            loadAvailablePlayers();
            if (String(event.playerId) === String(userId)) {
                loadMyPicks();
            }
        }

        function loadAvailablePlayers() {
            const team = $('#filter-team').val();
            const position = $('#filter-position').val();
            const search = $('#search-player').val();

            let query = `?`;
            if (team) query += `team=${encodeURIComponent(team)}&`;
            if (position) query += `position=${encodeURIComponent(position)}&`;
            if (search) query += `search=${encodeURIComponent(search)}&`;

            $.get(`/apis/v1/fantasy/games/${gameSeq}/available-players${query}`, function(data) {
                const tbody = $('#available-players-body');
                tbody.empty();
                data.forEach(player => {
                    const firstPos = player.position ? player.position.split(',')[0].trim().toLowerCase() : '';
                    const posClass = 'pos-' + firstPos;
                    // 'CL' -> 'pos-cp' mapping for color consistency if needed, but CSS has 'pos-cl' if I add it, or map here.
                    // CSS has .pos-cp. Let's map CL to CP if needed or add .pos-cl to CSS.
                    // Wait, I didn't add .pos-cl. I added .pos-cp.
                    // I'll check player.position values. If it's 'CL', I should use 'pos-cp'.
                    let cssClass = posClass;
                    if(firstPos === 'cl') cssClass = 'pos-cp';

                    tbody.append(`
                        <tr>
                            <td>${player.name}</td>
                            <td><span class="position-badge ${cssClass}">${player.position}</span></td>
                            <td><span class="team-badge">${player.team}</span></td>
                            <td>${player.stats || '-'}</td>
                            <td><button class="btn-draft" onclick="draftPlayer(${player.seq})">Draft</button></td>
                        </tr>
                    `);
                });
            });
        }

        function loadMyPicks() {
            $.get(`/apis/v1/fantasy/games/${gameSeq}/players/${userId}/picks`, function(data) {
                const list = $('#my-picks-list');
                list.empty();
                data.forEach(player => {
                    const firstPos = player.position ? player.position.split(',')[0].trim().toLowerCase() : '';
                    let cssClass = 'pos-' + firstPos;
                    if(firstPos === 'cl') cssClass = 'pos-cp';

                    list.append(`
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                            <strong>${player.name}</strong> <span class="position-badge ${cssClass}">${player.position}</span>
                        </li>
                    `);
                });
            });
        }

        function draftPlayer(playerSeq) {
            const data = {
                fantasyGameSeq: gameSeq,
                playerId: userId,
                fantasyPlayerSeq: playerSeq
            };

            $.ajax({
                url: '/apis/v1/fantasy/draft',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    console.log("Draft request sent successfully");
                },
                error: function(xhr) {
                    alert('Draft Failed: ' + (xhr.responseText || 'Error'));
                }
            });
        }
        /*]]>*/
    </script>
</div>
</body>
</html>
