<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Fantasy League - Draft Room</title>
    <link rel="stylesheet" th:href="@{/css/fantasy.css}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .draft-order-strip {
            display: flex;
            overflow-x: auto;
            background: #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            gap: 10px;
        }
        .draft-participant {
            padding: 5px 10px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            white-space: nowrap;
        }
        .draft-participant.active {
            background: #007bff;
            color: white;
            font-weight: bold;
            border-color: #0056b3;
        }
        .draft-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .timer { font-weight: bold; color: #d9534f; }
        .disabled-btn { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <header class="fantasy-header">
            <h1>Draft Room</h1>
            <span id="game-status" class="status-badge status-WAITING">Loading...</span>
        </header>

        <div th:replace="fragments/fantasy-nav :: nav(active='draft')"></div>

        <div id="draft-ui-container" style="display:none;">
            <div id="draft-order-strip" class="draft-order-strip"></div>
            <div class="draft-info-bar">
                <span>Round: <span id="current-round">-</span></span>
                <span>Turn: <strong id="current-turn-name">-</strong></span>
                <span>Time Left: <span id="timer" class="timer">--:--</span></span>
            </div>
        </div>


        <!-- Mobile Tabs -->
        <div class="draft-mobile-tabs">
            <button class="draft-tab active" onclick="switchDraftTab('available')">선수 목록</button>
            <button class="draft-tab" onclick="switchDraftTab('mypicks')">My Picks</button>
        </div>

        <div class="draft-container">
            <!-- Available Players -->
            <div id="tab-available" class="fantasy-card draft-tab-content active">
                <h2 class="card-title">선수 목록</h2>
                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filter-team" style="padding: 5px;">
                        <option value="">모든 팀</option>
                        <option value="두산">두산 베어스</option>
                        <option value="LG">LG 트윈스</option>
                        <option value="KIA">KIA 타이거즈</option>
                        <option value="삼성">삼성 라이온즈</option>
                        <option value="롯데">롯데 자이언츠</option>
                        <option value="한화">한화 이글스</option>
                        <option value="NC">NC 다이노스</option>
                        <option value="KT">KT 위즈</option>
                        <option value="SSG">SSG 랜더스</option>
                        <option value="키움">키움 히어로즈</option>
                    </select>
                    <select id="filter-position" style="padding: 5px;">
                        <option value="">모든 포지션</option>
                        <option value="C">C</option>
                        <option value="1B">1B</option>
                        <option value="2B">2B</option>
                        <option value="3B">3B</option>
                        <option value="SS">SS</option>
                        <option value="LF">LF</option>
                        <option value="CF">CF</option>
                        <option value="RF">RF</option>
                        <option value="DH">DH</option>
                        <option value="SP">SP</option>
                        <option value="RP">RP</option>
                        <option value="CL">CL</option>
                    </select>
                    <input type="text" id="search-player" placeholder="Search player..." style="padding: 5px; flex-grow: 1;">
                    <button class="btn-primary" onclick="loadAvailablePlayers()">검색</button>
                </div>
                <div class="table-responsive">
                <table class="fantasy-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Pos</th>
                            <th>Team</th>
                            <th>Stats</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="available-players-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                </div>
            </div>

            <!-- My Picks -->
            <div id="tab-mypicks" class="fantasy-card draft-tab-content">
                <h2 class="card-title">My Picks</h2>
                <ul id="my-picks-list" style="list-style: none; padding: 0;">
                    <!-- Populated by JS -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="hidden" id="gameSeq" th:value="${gameSeq}" />
    <input type="hidden" id="currentUserId" th:value="${currentUserId}" />

    <script th:inline="javascript">
        /*<![CDATA[*/
        const gameSeq = document.getElementById('gameSeq').value;
        const userId = document.getElementById('currentUserId').value;
        let stompClient = null;
        let isConnecting = false;

        // Game State
        let gameState = {
            status: 'WAITING',
            participants: [],
            nextPickerId: null,
            nextPickDeadline: null,
            ruleType: 'RULE_1',
            myPreferredTeam: null,
            round: 1 // Default
        };

        $(document).ready(function() {
            initGame();
            connectWebSocket();

            // Mobile sync: Refresh state when returning to tab
            document.addEventListener("visibilitychange", function() {
                if (document.visibilityState === 'visible') {
                    console.log("App resumed, syncing state...");
                    initGame();
                    connectWebSocket();
                }
            });

            $('#filter-team, #filter-position').change(function() {
                loadAvailablePlayers();
            });
            $('#search-player').on('keyup', function(e) {
                if (e.key === 'Enter') loadAvailablePlayers();
            });

            setInterval(updateTimer, 1000);
        });

        function switchDraftTab(tabName) {
            // Only effective on mobile where tabs are shown
            $('.draft-tab').removeClass('active');
            $(`.draft-tab[onclick="switchDraftTab('${tabName}')"]`).addClass('active');

            // Hide all tab contents and show the selected one
            // Note: On desktop, CSS should override this to always show both
            $('.draft-tab-content').removeClass('active');
            $(`#tab-${tabName}`).addClass('active');
        }

        function initGame() {
            $.get(`/apis/v1/fantasy/games/${gameSeq}/details`, function(data) {
                gameState.status = data.status;
                gameState.participants = data.participants || [];
                gameState.nextPickerId = data.nextPickerId;
                gameState.nextPickDeadline = data.nextPickDeadline;
                gameState.ruleType = data.ruleType; // RULE_1 or RULE_2
                gameState.round = data.roundNum;

                // Determine My Info
                const myPart = gameState.participants.find(p => String(p.participantId) === String(userId));
                if (myPart) {
                    gameState.myPreferredTeam = myPart.preferredTeam;
                }

                // Determine Round: Backend doesn't send round in details yet, default 1 or calculate if needed.
                // For MVP, if picking events happen, round will update.
                updateUI();
                loadAvailablePlayers();
                loadMyPicks();
            });
        }

        function updateUI() {
            // Update Status Badge
            $('#game-status').text(gameState.status).attr('class', 'status-badge status-' + gameState.status);

            // Show/Hide Admin Controls
            if (gameState.status === 'WAITING') {
                // Only show if element exists (admin only)
                if ($('#admin-controls').length) {
                   $('#admin-controls').show();
                }
                $('#draft-ui-container').hide();
            } else if (gameState.status === 'DRAFTING') {
                $('#admin-controls').hide();
                $('#draft-ui-container').show();
            } else {
                $('#admin-controls').hide();
                $('#draft-ui-container').hide();
            }

            renderOrderStrip();

            // Highlight Current Turn
            if (gameState.nextPickerId) {
                const picker = gameState.participants.find(p => p.participantId === gameState.nextPickerId);
                $('#current-turn-name').text(picker ? picker.teamName : 'Unknown');
                $('#current-round').text(gameState.round || '-');
            }
        }

        function renderOrderStrip() {
            const strip = $('#draft-order-strip');
            strip.empty();

            // Sort by draftOrder
            const sorted = [...gameState.participants].sort((a, b) => (a.draftOrder || 0) - (b.draftOrder || 0));

            sorted.forEach(p => {
                const isActive = (p.participantId === gameState.nextPickerId);
                strip.append(`
                    <div class="draft-participant ${isActive ? 'active' : ''}">
                        ${p.draftOrder}. ${p.teamName}
                    </div>
                `);
            });
        }

        function updateTimer() {
            if (gameState.status !== 'DRAFTING' || !gameState.nextPickDeadline) {
                $('#timer').text('--:--');
                return;
            }
            const now = new Date().getTime();
            const deadline = new Date(gameState.nextPickDeadline).getTime();
            const diff = deadline - now;

            if (diff <= 0) {
                $('#timer').text('00:00');
            } else {
                const min = Math.floor(diff / 60000);
                const sec = Math.floor((diff % 60000) / 1000);
                $('#timer').text(`${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`);
            }
        }


        function connectWebSocket() {
            if (isConnecting || (stompClient && stompClient.connected)) return;

            isConnecting = true;
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                isConnecting = false;
                stompClient.subscribe('/topic/draft/' + gameSeq, function(message) {
                    const event = JSON.parse(message.body);
                    handleDraftEvent(event);
                });
            }, function(error) {
                isConnecting = false;
                console.error('STOMP connection error:', error);
            });
        }

        function handleDraftEvent(event) {
            if (event.type === 'START') {
                gameState.status = 'DRAFTING';
                gameState.participants = event.draftOrder; // Update with ordered list
                gameState.nextPickerId = event.nextPickerId;
                gameState.nextPickDeadline = event.nextPickDeadline;
                gameState.round = event.round;
                updateUI();
                loadAvailablePlayers();
            } else if (event.type === 'PICK') {
                gameState.nextPickerId = event.nextPickerId;
                gameState.nextPickDeadline = event.nextPickDeadline;
                gameState.round = event.round;
                updateUI();
                loadAvailablePlayers();
                if (String(event.playerId) === String(userId)) {
                    loadMyPicks();
                }
            } else if (event.type === 'FINISH') {
                gameState.status = 'FINISHED'; // Or ONGOING
                gameState.nextPickerId = null;
                gameState.nextPickDeadline = null;
                alert("Draft Completed!");
                updateUI();
                loadAvailablePlayers();
                if (String(event.playerId) === String(userId)) {
                    loadMyPicks();
                }
            }
        }

        function loadAvailablePlayers() {
            const team = $('#filter-team').val();
            const position = $('#filter-position').val();
            const search = $('#search-player').val();

            let query = `?`;
            if (team) query += `team=${encodeURIComponent(team)}&`;
            if (position) query += `position=${encodeURIComponent(position)}&`;
            if (search) query += `search=${encodeURIComponent(search)}&`;

            $.get(`/apis/v1/fantasy/games/${gameSeq}/available-players${query}`, function(data) {
                const tbody = $('#available-players-body');
                tbody.empty();

                const isMyTurn = (String(gameState.nextPickerId) === String(userId));
                const isRound1 = (gameState.round === 1);

                data.forEach(player => {
                    const firstPos = player.position ? player.position.split(',')[0].trim().toLowerCase() : '';
                    let cssClass = 'pos-' + firstPos;
                    if(firstPos === 'cl') cssClass = 'pos-cp';

                    let disabled = !isMyTurn;
                    let btnText = "Draft";

                    // Rule 2 Check
                    if (isMyTurn && gameState.ruleType === 'RULE_2' && isRound1) {
                         // Check team
                         const myTeam = (gameState.myPreferredTeam || "").toLowerCase().trim();
                         const pTeam = (player.team || "").toLowerCase().trim();
                         if (myTeam && !pTeam.includes(myTeam) && !myTeam.includes(pTeam)) {
                             disabled = true;
                             btnText = "Restricted"; // Or just keep disabled
                         }
                    }

                    // Also disable if already picked (API should filter, but double check handled by disabled Draft button logic if needed, but API filters already)

                    tbody.append(`
                        <tr>
                            <td>${player.name}</td>
                            <td><span class="position-badge ${cssClass}">${player.position}</span></td>
                            <td><span class="team-badge">${player.team}</span></td>
                            <td>${player.stats || '-'}</td>
                            <td>
                                <button class="btn-draft ${disabled ? 'disabled-btn' : ''}"
                                        onclick="draftPlayer(${player.seq})"
                                        ${disabled ? 'disabled' : ''}>
                                    ${btnText}
                                </button>
                            </td>
                        </tr>
                    `);
                });
            });
        }

        function loadMyPicks() {
            $.get(`/apis/v1/fantasy/games/${gameSeq}/players/${userId}/picks`, function(data) {
                const list = $('#my-picks-list');
                list.empty();
                data.forEach(player => {
                    const firstPos = player.position ? player.position.split(',')[0].trim().toLowerCase() : '';
                    let cssClass = 'pos-' + firstPos;
                    if(firstPos === 'cl') cssClass = 'pos-cp';

                    list.append(`
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                            <strong>${player.name}</strong> <span class="position-badge ${cssClass}">${player.position}</span>
                        </li>
                    `);
                });
            });
        }

        function draftPlayer(playerSeq) {
            const data = {
                fantasyGameSeq: gameSeq,
                playerId: userId,
                fantasyPlayerSeq: playerSeq
            };

            $.ajax({
                url: '/apis/v1/fantasy/draft',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    console.log("Draft request sent successfully");
                },
                error: function(xhr) {
                    alert('Draft 실패: ' + (xhr.responseText || 'Error'));
                }
            });
        }
        /*]]>*/
    </script>
</div>
</body>
</html>
