<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Fantasy League - My Team</title>
    <link rel="stylesheet" th:href="@{/css/fantasy.css}">
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <header class="fantasy-header">
            <h1>My Team Roster</h1>
            <select id="gameSelector" class="form-control" style="width: 250px; padding: 5px;">
                <option value="">Loading Games...</option>
            </select>
        </header>

        <div th:replace="fragments/fantasy-nav :: nav(active='my-team')"></div>

        <div id="roster-view" class="my-team-container" style="display:none;">
            <!-- Field View -->
            <div class="fantasy-card">
                <h2 class="card-title">Fielding & Batting</h2>
                <div class="baseball-field">
                    <!-- Positions -->
                    <div class="field-position pos-c" id="slot-C">
                        <span class="pos-label">C</span>
                        <span class="player-name">-</span>
                    </div>
                    <div class="field-position pos-1b" id="slot-1B">
                        <span class="pos-label">1B</span>
                        <span class="player-name">-</span>
                    </div>
                    <div class="field-position pos-2b" id="slot-2B">
                        <span class="pos-label">2B</span>
                        <span class="player-name">-</span>
                    </div>
                    <div class="field-position pos-3b" id="slot-3B">
                        <span class="pos-label">3B</span>
                        <span class="player-name">-</span>
                    </div>
                    <div class="field-position pos-ss" id="slot-SS">
                        <span class="pos-label">SS</span>
                        <span class="player-name">-</span>
                    </div>
                    <div class="field-position pos-lf" id="slot-LF">
                        <span class="pos-label">LF</span>
                        <span class="player-name">-</span>
                    </div>
                    <div class="field-position pos-cf" id="slot-CF">
                        <span class="pos-label">CF</span>
                        <span class="player-name">-</span>
                    </div>
                    <div class="field-position pos-rf" id="slot-RF">
                        <span class="pos-label">RF</span>
                        <span class="player-name">-</span>
                    </div>
                    <!-- DH at Bottom Right -->
                    <div class="field-position pos-dh" id="slot-DH">
                        <span class="pos-label">DH</span>
                        <span class="player-name">-</span>
                    </div>
                </div>
            </div>

            <!-- Pitching View -->
            <div class="fantasy-card">
                <h2 class="card-title">Pitching Staff</h2>
                <div class="pitcher-list" id="pitcher-list-container">
                    <!-- SP Slots -->
                    <div class="pitcher-slot" id="slot-SP-1"><span class="pitcher-role">SP</span><span class="player-name">-</span></div>
                    <div class="pitcher-slot" id="slot-SP-2"><span class="pitcher-role">SP</span><span class="player-name">-</span></div>
                    <div class="pitcher-slot" id="slot-SP-3"><span class="pitcher-role">SP</span><span class="player-name">-</span></div>
                    <div class="pitcher-slot" id="slot-SP-4"><span class="pitcher-role">SP</span><span class="player-name">-</span></div>

                    <!-- RP Slots -->
                    <div class="pitcher-slot" id="slot-RP-1"><span class="pitcher-role">RP</span><span class="player-name">-</span></div>
                    <div class="pitcher-slot" id="slot-RP-2"><span class="pitcher-role">RP</span><span class="player-name">-</span></div>
                    <div class="pitcher-slot" id="slot-RP-3"><span class="pitcher-role">RP</span><span class="player-name">-</span></div>
                    <div class="pitcher-slot" id="slot-RP-4"><span class="pitcher-role">RP</span><span class="player-name">-</span></div>

                    <!-- CL Slot -->
                    <div class="pitcher-slot" id="slot-CL-1"><span class="pitcher-role">CP</span><span class="player-name">-</span></div>
                </div>
            </div>
        </div>

        <div id="no-game-msg" style="display:none; text-align: center; padding: 50px;">
            <p style="font-size: 1.2rem; color: #666;">No active fantasy teams found. Join a game first!</p>
            <a href="/fantasy" class="btn btn-primary">Go to Dashboard</a>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        let selectedSlotId = null;

        $(document).ready(function() {
            loadMyGames();

            $('#gameSelector').change(function() {
                const seq = $(this).val();
                if (seq) {
                    loadRoster(seq);
                }
            });

            // Double Click Swap Logic
            $('.field-position, .pitcher-slot').dblclick(function() {
                const currentId = $(this).attr('id');
                const player = $(this).data('player');

                // If no slot selected yet
                if (selectedSlotId === null) {
                    // Allow selecting empty slots
                    selectedSlotId = currentId;
                    $(this).addClass('selected-player');
                } else {
                    // If same slot clicked again -> Deselect
                    if (selectedSlotId === currentId) {
                        $(this).removeClass('selected-player');
                        selectedSlotId = null;
                        return;
                    }

                    // Second slot selected -> Attempt Swap
                    const slotA = $('#' + selectedSlotId);
                    const slotB = $(this);

                    if (checkSwapValidity(slotA, slotB)) {
                        swapSlots(slotA, slotB);
                    } else {
                        // Optional: alert('Invalid swap');
                    }

                    // Cleanup
                    slotA.removeClass('selected-player');
                    selectedSlotId = null;
                }
            });
        });

        function checkSwapValidity(slotA, slotB) {
            const pA = slotA.data('player');
            const pB = slotB.data('player');

            // If both are empty, nothing to do, but technically valid? Or invalid?
            // Let's say valid, nothing changes.
            if (!pA && !pB) return true;

            // Check if pA fits in slotB
            if (pA && !isPlayerValidForSlot(pA, slotB)) {
                return false;
            }

            // Check if pB fits in slotA
            if (pB && !isPlayerValidForSlot(pB, slotA)) {
                return false;
            }

            return true;
        }

        function isPlayerValidForSlot(player, slot) {
             // Get Slot Position Requirement
            let requiredPos = '';
            const id = slot.attr('id'); // slot-2B, slot-SP-1
            if (id.startsWith('slot-SP') || id.startsWith('slot-RP') || id.startsWith('slot-CL')) {
                const parts = id.split('-');
                requiredPos = parts[1]; // SP, RP, CL
            } else {
                requiredPos = id.replace('slot-', '');
            }

            // Check Player Positions
            const validPositions = player.position.split(',').map(s => s.trim());

            // Map requiredPos to equivalents
            if (requiredPos === 'CL' && validPositions.includes('CP')) return true;
            if (requiredPos === 'CP' && validPositions.includes('CL')) return true;

            if (validPositions.includes(requiredPos)) return true;

            // DH Check
            if (requiredPos === 'DH' && !isPitcher(validPositions[0])) return true;

            return false;
        }

        function isPitcher(pos) {
            return ['SP', 'RP', 'CP', 'CL'].includes(pos);
        }

        function swapSlots(slotA, slotB) {
            const pA = slotA.data('player');
            const pB = slotB.data('player');

            // Swap Data
            slotA.data('player', pB);
            slotB.data('player', pA);

            // Re-render
            renderSlot(slotA, pB);
            renderSlot(slotB, pA);
        }

        function renderSlot(slot, player) {
            const isField = slot.hasClass('field-position');
            const nameElem = slot.find('.player-name');

            // Reset content
            nameElem.text('-');
            if (isField) slot.find('.player-team').remove();
            else slot.removeClass('filled');
            slot.removeClass('invalid-position'); // Reset validation state

            if (player) {
                if (isField) {
                    nameElem.text(player.name);
                    slot.append(`<span class="player-team" style="display:block; font-size:0.8rem; color:#666;">${player.team}</span>`);
                } else {
                    nameElem.text(`${player.name} (${player.team})`);
                    slot.addClass('filled');
                }
                // Validation check (if it was invalid before, or just re-validate?)
                // Usually render clears invalid, swap triggers validate.
            }
        }

        // function validateSlot(slot) { ... } Removed as validation is now pre-swap.

        function loadMyGames() {
            $.get('/apis/v1/fantasy/my-games', function(games) {
                const select = $('#gameSelector');
                select.empty();

                if (games.length === 0) {
                    select.append('<option value="">No Games</option>');
                    $('#no-game-msg').show();
                    return;
                }

                // Sort by ID desc (latest)
                games.sort((a, b) => b.seq - a.seq);

                games.forEach(g => {
                    select.append(`<option value="${g.seq}">${g.title} (${g.status})</option>`);
                });

                // Select first and load
                select.val(games[0].seq);
                loadRoster(games[0].seq);
                $('#roster-view').show();
            }).fail(function() {
                // If API fails or no games
                select.append('<option value="">Error Loading</option>');
            });
        }

        function loadRoster(gameSeq) {
            // Reset slots
            $('.player-name').text('-');
            $('.player-team').remove();
            $('.pitcher-slot').removeClass('filled');
            $('.field-position, .pitcher-slot').data('player', null).removeClass('selected-player invalid-position invalid-position');
            selectedSlotId = null;

            // Use my-picks endpoint which uses token ID
            $.get(`/apis/v1/fantasy/games/${gameSeq}/my-picks`, function(players) {
                const filledSlots = {};
                const spCount = { count: 1 };
                const rpCount = { count: 1 };

                players.forEach(p => {
                    // Position mapping
                    // p.position might be "C" or "C, 1B"
                    const positions = p.position.split(',').map(s => s.trim());
                    let assigned = false;

                    // 1. Try Primary Positions first
                    for (const pos of positions) {
                        if (isPitcher(pos)) continue;
                        if (!filledSlots[pos]) {
                            fillSlot(pos, p);
                            filledSlots[pos] = true;
                            assigned = true;
                            break;
                        }
                    }

                    // 2. Try DH
                    if (!assigned && !isPitcher(positions[0])) {
                        if (!filledSlots['DH']) {
                            fillSlot('DH', p);
                            filledSlots['DH'] = true;
                            assigned = true;
                        }
                    }

                    // 3. Pitchers
                    if (!assigned && isPitcher(positions[0])) {
                         if (positions.includes('SP')) {
                             assignPitcher('SP', spCount, p);
                         } else if (positions.includes('RP')) {
                             assignPitcher('RP', rpCount, p);
                         } else if (positions.includes('CL') || positions.includes('CP')) {
                             if (!filledSlots['CL']) {
                                 fillPitcherSlot('CL-1', p);
                                 filledSlots['CL'] = true;
                             }
                         }
                    }
                });
            });
        }

        function isPitcher(pos) {
            return ['SP', 'RP', 'CP', 'CL'].includes(pos);
        }

        function fillSlot(pos, player) {
            const slot = $(`#slot-${pos}`);
            if (slot.length) {
                // Attach Data
                slot.data('player', player);
                renderSlot(slot, player);
            }
        }

        function assignPitcher(type, counterObj, player) {
            if (counterObj.count <= 4) {
                fillPitcherSlot(`${type}-${counterObj.count}`, player);
                counterObj.count++;
            }
        }

        function fillPitcherSlot(idSuffix, player) {
            const slot = $(`#slot-${idSuffix}`);
            if (slot.length) {
                slot.data('player', player);
                renderSlot(slot, player);
            }
        }
        /*]]>*/
    </script>
</div>
</body>
</html>
