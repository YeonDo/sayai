<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Fantasy League - Ranking</title>
    <link rel="stylesheet" th:href="@{/css/fantasy.css}">
    <style>
        .ranking-header {
            text-align: center;
            background-color: #f8f9fa;
            border-bottom: 2px solid #ddd;
            font-weight: bold;
        }
        .ranking-value {
            text-align: center;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <header class="fantasy-header">
            <h1>Game Ranking</h1>
            <select id="gameSelector" class="form-control" style="width: 250px; padding: 5px;">
                <option value="">Loading Games...</option>
            </select>
        </header>

        <div th:replace="fragments/fantasy-nav :: nav(active='ranking')"></div>

        <div id="ranking-view" class="fantasy-card" style="display:none;">
            <h2 class="card-title">Rotisserie Standings (2026 Simulation)</h2>
            <div style="overflow-x: auto;">
                <table class="table table-hover fantasy-table">
                    <thead>
                        <tr>
                            <th class="ranking-header">Team Name</th>
                            <th class="ranking-header">Total Point</th>
                            <th class="ranking-header">Point</th>
                            <th class="ranking-header">AVG</th>
                            <th class="ranking-header">HR</th>
                            <th class="ranking-header">RBI</th>
                            <th class="ranking-header">SO (Bat)</th>
                            <th class="ranking-header">SB</th>
                            <th class="ranking-header">W</th>
                            <th class="ranking-header">K (Pitch)</th>
                            <th class="ranking-header">ERA</th>
                            <th class="ranking-header">WHIP</th>
                            <th class="ranking-header">SV</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="points-msg" style="display:none; text-align: center; padding: 50px;">
            <p style="font-size: 1.2rem; color: #666;">Ranking table is not available for Point Scoring games.</p>
        </div>

        <div id="no-game-msg" style="display:none; text-align: center; padding: 50px;">
            <p style="font-size: 1.2rem; color: #666;">No active fantasy teams found. Join a game first!</p>
            <a href="/fantasy" class="btn btn-primary">Go to Dashboard</a>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function() {
            loadMyGames();

            $('#gameSelector').change(function() {
                const seq = $(this).val();
                if (seq) {
                    loadRanking(seq);
                }
            });
        });

        function loadMyGames() {
            $.get('/apis/v1/fantasy/my-games', function(games) {
                const select = $('#gameSelector');
                select.empty();

                if (games.length === 0) {
                    select.append('<option value="">No Games</option>');
                    $('#no-game-msg').show();
                    return;
                }

                // Sort by ID desc (latest)
                games.sort((a, b) => b.seq - a.seq);

                games.forEach(g => {
                    select.append(`<option value="${g.seq}">${g.title} (${g.status})</option>`);
                });

                // Select first and load
                select.val(games[0].seq);
                loadRanking(games[0].seq);
            });
        }

        function loadRanking(gameSeq) {
            $('#ranking-view').hide();
            $('#points-msg').hide();

            $.get(`/apis/v1/fantasy/games/${gameSeq}/ranking`, function(data) {
                if (data.scoringType === 'POINTS') {
                    $('#points-msg').show();
                    return;
                }

                const tbody = $('#ranking-body');
                tbody.empty();

                // Pre-process: Group per-round stats to calculate per-round ranks
                // roundsData[roundNum] = [ { teamName, stats... }, ... ]
                const roundsData = {};
                data.rankings.forEach(r => {
                    if (r.rounds) {
                        r.rounds.forEach(roundStat => {
                            if (!roundsData[roundStat.round]) {
                                roundsData[roundStat.round] = [];
                            }
                            roundsData[roundStat.round].push({
                                teamName: r.teamName,
                                ...roundStat
                            });
                        });
                    }
                });

                // Calculate ranks for each round
                // roundRanks[roundNum] = { category: { teamName: rank } }
                const roundRanks = {};
                Object.keys(roundsData).forEach(roundNum => {
                    const rData = roundsData[roundNum];
                    roundRanks[roundNum] = {
                        totalPoints: calculateRanks(rData, 'totalPoints', false),
                        avg: calculateRanks(rData, 'avg', false),
                        hr: calculateRanks(rData, 'hr', false),
                        rbi: calculateRanks(rData, 'rbi', false),
                        soBatter: calculateRanks(rData, 'soBatter', true), // Low is better
                        sb: calculateRanks(rData, 'sb', false),
                        wins: calculateRanks(rData, 'wins', false),
                        soPitcher: calculateRanks(rData, 'soPitcher', false),
                        era: calculateRanks(rData, 'era', true), // Low is better
                        whip: calculateRanks(rData, 'whip', true), // Low is better
                        saves: calculateRanks(rData, 'saves', false)
                    };
                });

                // Also calculate Total Point Rank for the main column
                const totalRankMap = calculateRanks(data.rankings, 'totalPoints', false);

                function getEmoji(rank) {
                    if (rank === 1) return 'ðŸ¥‡ ';
                    if (rank === 2) return 'ðŸ¥ˆ ';
                    if (rank === 3) return 'ðŸ¥‰ ';
                    return '';
                }

                data.rankings.forEach(r => {
                    const rowCount = (r.rounds && r.rounds.length > 0) ? r.rounds.length : 1;
                    const totalEmoji = getEmoji(totalRankMap[r.teamName]);

                    // First Row (Main + First Round)
                    let html = '<tr>';

                    // Merged Cells
                    html += `<td rowspan="${rowCount}" style="font-weight:bold; vertical-align:middle; background:#fff;">${r.teamName}</td>`;
                    html += `<td rowspan="${rowCount}" class="ranking-value" style="font-weight:bold; color:#007bff; vertical-align:middle; background:#fff; font-size:1.1rem;">${totalEmoji}${r.totalPoints ? r.totalPoints.toFixed(1) : '0.0'}</td>`;

                    // First Round Data
                    if (r.rounds && r.rounds.length > 0) {
                        const first = r.rounds[0];
                        const rk = roundRanks[first.round];
                        html += renderRoundCells(first, rk, r.teamName);
                    } else {
                        // Empty cells if no round data
                        html += '<td colspan="11" class="ranking-value">-</td>';
                    }
                    html += '</tr>';
                    tbody.append(html);

                    // Subsequent Rows
                    if (r.rounds && r.rounds.length > 1) {
                        for(let i=1; i<r.rounds.length; i++) {
                            const sub = r.rounds[i];
                            const subRk = roundRanks[sub.round];
                            let subHtml = '<tr>';
                            subHtml += renderRoundCells(sub, subRk, r.teamName);
                            subHtml += '</tr>';
                            tbody.append(subHtml);
                        }
                    }
                });

                function renderRoundCells(stats, rankMap, teamName) {
                    // rankMap is for a specific round: { category: { teamName: rank } }
                    // We need to pass teamName to look up rank

                    const p = (key) => {
                        const rank = rankMap[key][teamName];
                        const val = stats[key];
                        const fixed = (key === 'avg') ? 3 : (key === 'era' || key === 'whip' || key === 'totalPoints') ? 2 : 0; // Point usually integer? But totalPoints in DTO is double.
                        // Wait, 'Point' column in image is round point. In DTO it's 'totalPoints' field of FantasyScoreDto.
                        // And image shows 120, 110 (integers?). Let's use 1 decimal for points.
                        if (val === null || val === undefined) return '';

                        let displayVal = val;
                        if (key === 'avg') displayVal = val.toFixed(3);
                        else if (key === 'era' || key === 'whip') displayVal = val.toFixed(2);
                        else if (key === 'totalPoints') displayVal = val.toFixed(1); // Round Point

                        return `<td class="ranking-value">${getEmoji(rank)}${displayVal}</td>`;
                    };

                    // Mappings:
                    // DTO field -> Table Column
                    // Point -> totalPoints
                    // AVG -> avg
                    // HR -> hr
                    // RBI -> rbi
                    // SO(Bat) -> soBatter
                    // SB -> sb
                    // W -> wins
                    // K(Pitch) -> soPitcher
                    // ERA -> era
                    // WHIP -> whip
                    // SV -> saves

                    let s = '';
                    s += p('totalPoints');
                    s += p('avg');
                    s += p('hr');
                    s += p('rbi');
                    s += p('soBatter');
                    s += p('sb');
                    s += p('wins');
                    s += p('soPitcher');
                    s += p('era');
                    s += p('whip');
                    s += p('saves');
                    return s;
                }
            });
        }

        function calculateRanks(data, key, ascending) {
            const sorted = [...data].sort((a, b) => {
                const valA = a[key] || 0;
                const valB = b[key] || 0;
                if (ascending) return valA - valB;
                return valB - valA;
            });

            const ranks = {};
            let currentRank = 1;
            for (let i = 0; i < sorted.length; i++) {
                if (i > 0) {
                    const prev = sorted[i - 1][key] || 0;
                    const curr = sorted[i][key] || 0;
                    if (Math.abs(prev - curr) > 0.00001) { // Simple float comparison
                        currentRank = i + 1;
                    }
                }
                ranks[sorted[i].teamName] = currentRank;
            }
            return ranks;
        }

                $('#ranking-view').show();
            });
        }
        /*]]>*/
    </script>
</div>
</body>
</html>
