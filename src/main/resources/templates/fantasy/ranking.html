<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Fantasy League - Ranking</title>
    <link rel="stylesheet" th:href="@{/css/fantasy.css}">
    <style>
        .ranking-header {
            text-align: center;
            background-color: #f8f9fa;
            border-bottom: 2px solid #ddd;
            font-weight: bold;
        }
        .ranking-value {
            text-align: center;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <header class="fantasy-header">
            <h1>Game Ranking</h1>
            <select id="gameSelector" class="form-control" style="width: 250px; padding: 5px;">
                <option value="">Loading Games...</option>
            </select>
        </header>

        <div th:replace="fragments/fantasy-nav :: nav(active='ranking')"></div>

        <div id="ranking-view" class="fantasy-card" style="display:none;">
            <h2 class="card-title">Rotisserie Standings (2026 Simulation)</h2>
            <div style="overflow-x: auto;">
                <table class="table table-hover fantasy-table">
                    <thead>
                        <tr>
                            <th class="ranking-header">Team Name</th>
                            <th class="ranking-header">Total Points</th>
                            <th class="ranking-header">AVG</th>
                            <th class="ranking-header">HR</th>
                            <th class="ranking-header">RBI</th>
                            <th class="ranking-header">SO (Bat)</th>
                            <th class="ranking-header">SB</th>
                            <th class="ranking-header">W</th>
                            <th class="ranking-header">K (Pitch)</th>
                            <th class="ranking-header">ERA</th>
                            <th class="ranking-header">WHIP</th>
                            <th class="ranking-header">SV</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- Filled by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="points-msg" style="display:none; text-align: center; padding: 50px;">
            <p style="font-size: 1.2rem; color: #666;">Ranking table is not available for Point Scoring games.</p>
        </div>

        <div id="no-game-msg" style="display:none; text-align: center; padding: 50px;">
            <p style="font-size: 1.2rem; color: #666;">No active fantasy teams found. Join a game first!</p>
            <a href="/fantasy" class="btn btn-primary">Go to Dashboard</a>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function() {
            loadMyGames();

            $('#gameSelector').change(function() {
                const seq = $(this).val();
                if (seq) {
                    loadRanking(seq);
                }
            });
        });

        function loadMyGames() {
            $.get('/apis/v1/fantasy/my-games', function(games) {
                const select = $('#gameSelector');
                select.empty();

                if (games.length === 0) {
                    select.append('<option value="">No Games</option>');
                    $('#no-game-msg').show();
                    return;
                }

                // Sort by ID desc (latest)
                games.sort((a, b) => b.seq - a.seq);

                games.forEach(g => {
                    select.append(`<option value="${g.seq}">${g.title} (${g.status})</option>`);
                });

                // Select first and load
                select.val(games[0].seq);
                loadRanking(games[0].seq);
            });
        }

        function loadRanking(gameSeq) {
            $('#ranking-view').hide();
            $('#points-msg').hide();

            $.get(`/apis/v1/fantasy/games/${gameSeq}/ranking`, function(data) {
                if (data.scoringType === 'POINTS') {
                    $('#points-msg').show();
                    return;
                }

                const tbody = $('#ranking-body');
                tbody.empty();

                // Calculate ranks for each category
                const rankMaps = {
                    totalPoints: calculateRanks(data.rankings, 'totalPoints', false),
                    battingAvg: calculateRanks(data.rankings, 'battingAvg', false),
                    homeruns: calculateRanks(data.rankings, 'homeruns', false),
                    rbi: calculateRanks(data.rankings, 'rbi', false),
                    batterStrikeOuts: calculateRanks(data.rankings, 'batterStrikeOuts', true), // Low is better
                    stolenBases: calculateRanks(data.rankings, 'stolenBases', false),
                    wins: calculateRanks(data.rankings, 'wins', false),
                    pitcherStrikeOuts: calculateRanks(data.rankings, 'pitcherStrikeOuts', false),
                    era: calculateRanks(data.rankings, 'era', true), // Low is better
                    whip: calculateRanks(data.rankings, 'whip', true), // Low is better
                    saves: calculateRanks(data.rankings, 'saves', false)
                };

                function getEmoji(rank) {
                    if (rank === 1) return 'ðŸ¥‡ ';
                    if (rank === 2) return 'ðŸ¥ˆ ';
                    if (rank === 3) return 'ðŸ¥‰ ';
                    return '';
                }

                data.rankings.forEach(r => {
                    const row = `
                        <tr>
                            <td style="font-weight:bold;">${r.teamName}</td>
                            <td class="ranking-value" style="font-weight:bold; color: #007bff;">${getEmoji(rankMaps.totalPoints[r.teamName])}${r.totalPoints ? r.totalPoints.toFixed(1) : '0.0'}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.battingAvg[r.teamName])}${r.battingAvg ? r.battingAvg.toFixed(3) : '0.000'}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.homeruns[r.teamName])}${r.homeruns}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.rbi[r.teamName])}${r.rbi}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.batterStrikeOuts[r.teamName])}${r.batterStrikeOuts}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.stolenBases[r.teamName])}${r.stolenBases}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.wins[r.teamName])}${r.wins}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.pitcherStrikeOuts[r.teamName])}${r.pitcherStrikeOuts}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.era[r.teamName])}${r.era ? r.era.toFixed(2) : '0.00'}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.whip[r.teamName])}${r.whip ? r.whip.toFixed(2) : '0.00'}</td>
                            <td class="ranking-value">${getEmoji(rankMaps.saves[r.teamName])}${r.saves}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            });
        }

        function calculateRanks(data, key, ascending) {
            const sorted = [...data].sort((a, b) => {
                const valA = a[key] || 0;
                const valB = b[key] || 0;
                if (ascending) return valA - valB;
                return valB - valA;
            });

            const ranks = {};
            let currentRank = 1;
            for (let i = 0; i < sorted.length; i++) {
                if (i > 0) {
                    const prev = sorted[i - 1][key] || 0;
                    const curr = sorted[i][key] || 0;
                    if (Math.abs(prev - curr) > 0.00001) { // Simple float comparison
                        currentRank = i + 1;
                    }
                }
                ranks[sorted[i].teamName] = currentRank;
            }
            return ranks;
        }

                $('#ranking-view').show();
            });
        }
        /*]]>*/
    </script>
</div>
</body>
</html>
