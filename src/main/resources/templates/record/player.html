<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sayai - Player Record</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Main GNB -->
    <div class="gnb">
        <div class="gnb-left">
            <a href="/record">기록 조회</a>
            <a href="/fantasy">판타지 리그</a>
            <a href="/episodes/1">사야이 뷰어</a>
        </div>
        <div class="gnb-right">
            <button type="button">로그인</button>
        </div>
    </div>

    <div class="container">
        <!-- Sub GNB -->
        <div class="sub-gnb">
            <a href="/record/game">경기 조회</a>
            <a href="/record/player" class="active">선수 조회</a>
        </div>

        <!-- Search Area -->
        <div class="search-section">
            <!-- Left: Player Search -->
            <div class="search-box player-search">
                <h3>선수 선택</h3>
                <div class="search-content">
                    <input type="text" id="playerInput" list="playerList" placeholder="선수명 검색 (비워두면 전체)">
                    <datalist id="playerList">
                        <!-- Options will be populated by JS -->
                    </datalist>
                </div>
            </div>

            <!-- Right: Date Range -->
            <div class="search-box date-search">
                <h3>기간 설정</h3>
                <div class="search-content">
                    <input type="date" id="startDate">
                    <span>~</span>
                    <input type="date" id="endDate">

                    <div class="shortcut-btns">
                        <button onclick="setYear2026()">올해(2026)</button>
                        <button onclick="setThisMonth()">이번달</button>
                    </div>

                    <button class="btn-search" onclick="searchRecords()" style="margin-left: auto;">조회</button>
                </div>
            </div>
        </div>

        <!-- Result Area -->
        <div id="loading" class="loading">데이터를 불러오는 중...</div>
        <div id="resultArea">
            <div class="table-responsive">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <!-- Rank isn't usually sortable as it's computed, but let's keep it static -->
                            <th>순위</th>
                            <th onclick="sortBy('name')" data-key="name">이름</th>
                            <th onclick="sortBy('battingAvg')" data-key="battingAvg">타율</th>
                            <th onclick="sortBy('totalGames')" data-key="totalGames">경기</th>
                            <th onclick="sortBy('playerAppearance')" data-key="playerAppearance">타석</th>
                            <th onclick="sortBy('atBat')" data-key="atBat">타수</th>
                            <th onclick="sortBy('totalHits')" data-key="totalHits">안타</th>
                            <th onclick="sortBy('doubles')" data-key="doubles">2루타</th>
                            <th onclick="sortBy('triples')" data-key="triples">3루타</th>
                            <th onclick="sortBy('homeruns')" data-key="homeruns">홈런</th>
                            <th onclick="sortBy('rbi')" data-key="rbi">타점</th>
                            <th onclick="sortBy('runs')" data-key="runs">득점</th>
                            <th onclick="sortBy('sb')" data-key="sb">도루</th>
                            <th onclick="sortBy('baseOnBall')" data-key="baseOnBall">볼넷</th>
                            <th onclick="sortBy('strikeOut')" data-key="strikeOut">삼진</th>
                            <th onclick="sortBy('onBasePer')" data-key="onBasePer">출루율</th>
                            <th onclick="sortBy('slugPer')" data-key="slugPer">장타율</th>
                            <th onclick="sortBy('ops')" data-key="ops">OPS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Results will be injected here -->
                    </tbody>
                </table>
            </div>
            <div id="noResults" class="no-results">검색 결과가 없습니다.</div>
        </div>
    </div>

    <script>
        // Local Cache for Players: {id, name}
        let playerCache = [];
        let currentData = [];
        let sortState = { key: 'battingAvg', dir: 'desc' };

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            // Set default date range (2026 Full Year)
            setYear2026();

            // Load Players for the dropdown
            await fetchPlayers();

            // Load Initial Records (All Players, Default Date)
            await searchRecords();
        });

        // --- Date Helpers ---
        function setYear2026() {
            document.getElementById('startDate').value = '2026-01-01';
            document.getElementById('endDate').value = '2026-12-31';
        }

        function setThisMonth() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const lastDay = new Date(year, now.getMonth() + 1, 0).getDate();
            document.getElementById('startDate').value = `${year}-${month}-01`;
            document.getElementById('endDate').value = `${year}-${month}-${lastDay}`;
        }

        // --- API Calls ---

        // 1. Fetch All Players
        async function fetchPlayers() {
            try {
                const response = await fetch('/apis/v1/player/all');
                if (!response.ok) throw new Error('Failed to fetch players');
                const players = await response.json();
                playerCache = players.map(p => ({ id: p.playerId, name: p.name }));
                playerCache.sort((a, b) => a.id - b.id);

                const dataList = document.getElementById('playerList');
                dataList.innerHTML = '';
                playerCache.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.name;
                    option.dataset.id = p.id;
                    dataList.appendChild(option);
                });

            } catch (error) {
                console.error('Error fetching players:', error);
            }
        }

        // 2. Search Records
        async function searchRecords() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const playerNameInput = document.getElementById('playerInput').value.trim();

            if (!startDate || !endDate) {
                alert('기간을 설정해주세요.');
                return;
            }

            let selectedPlayerId = null;
            if (playerNameInput) {
                const found = playerCache.find(p => p.name === playerNameInput);
                if (found) {
                    selectedPlayerId = found.id;
                }
            }

            showLoading(true);

            try {
                let url = '';
                if (selectedPlayerId) {
                    // Exact ID match
                    url = `/apis/v1/player/hitter/${selectedPlayerId}?start=${startDate}&end=${endDate}`;
                } else if (playerNameInput) {
                     // Name entered but not resolved to ID
                     alert('선수 목록에 없는 이름입니다. 정확한 이름을 입력하거나 목록에서 선택해주세요.');
                     showLoading(false);
                     return;
                } else {
                    // All Players (No name input)
                    url = `/apis/v1/player/hitter/all?start=${startDate}&end=${endDate}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch records');

                let data = await response.json();

                if (selectedPlayerId && !Array.isArray(data)) {
                    data = [data];
                }

                currentData = data;
                sortData(sortState.key, sortState.dir);

            } catch (error) {
                console.error('Error searching records:', error);
                alert('기록을 불러오는 중 오류가 발생했습니다.');
                renderTable([]);
            } finally {
                showLoading(false);
            }
        }

        // --- Sorting ---
        function sortBy(key) {
            if (sortState.key === key) {
                sortState.dir = sortState.dir === 'desc' ? 'asc' : 'desc';
            } else {
                sortState.key = key;
                sortState.dir = 'desc';
            }
            sortData(key, sortState.dir);
        }

        function sortData(key, dir) {
            if (!currentData || currentData.length === 0) {
                renderTable([]);
                return;
            }

            currentData.sort((a, b) => {
                let valA = getValue(a, key);
                let valB = getValue(b, key);

                // Handle strings (names)
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }

                // Handle numbers
                return dir === 'asc' ? valA - valB : valB - valA;
            });

            updateSortIcons(key, dir);
            renderTable(currentData);
        }

        function getValue(obj, key) {
             if (key === 'ops') {
                 return (obj.onBasePer || 0) + (obj.slugPer || 0);
             }
             return obj[key] !== undefined && obj[key] !== null ? obj[key] : 0;
        }

        function updateSortIcons(key, dir) {
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.key === key) {
                    th.classList.add(dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

        // --- Rendering ---
        function renderTable(data) {
            const tbody = document.querySelector('#resultTable tbody');
            const noResults = document.getElementById('noResults');
            const table = document.getElementById('resultTable');

            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                table.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            noResults.style.display = 'none';

            data.forEach((p, index) => {
                const tr = document.createElement('tr');
                const ops = ((p.onBasePer || 0) + (p.slugPer || 0)).toFixed(3);
                const avg = (p.battingAvg || 0).toFixed(3);
                const val = (v) => v !== undefined && v !== null ? v : 0;

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${p.name}</td>
                    <td>${avg}</td>
                    <td>${val(p.totalGames)}</td>
                    <td>${val(p.playerAppearance)}</td>
                    <td>${val(p.atBat)}</td>
                    <td>${val(p.totalHits)}</td>
                    <td>${val(p.doubles)}</td>
                    <td>${val(p.triples)}</td>
                    <td>${val(p.homeruns)}</td>
                    <td>${val(p.rbi)}</td>
                    <td>${val(p.runs)}</td>
                    <td>${val(p.sb)}</td>
                    <td>${val(p.baseOnBall)}</td>
                    <td>${val(p.strikeOut)}</td>
                    <td>${(p.onBasePer || 0).toFixed(3)}</td>
                    <td>${(p.slugPer || 0).toFixed(3)}</td>
                    <td>${ops}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showLoading(isLoading) {
            const loading = document.getElementById('loading');
            const resultArea = document.getElementById('resultArea');
            if (isLoading) {
                loading.style.display = 'block';
                resultArea.style.display = 'none';
            } else {
                loading.style.display = 'none';
                resultArea.style.display = 'block';
            }
        }
    </script>
</body>
</html>
