<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sayai - Game Record</title>
    <link rel="stylesheet" href="/css/style.css">
    <!-- Auth dependencies -->
    <link rel="stylesheet" href="/css/fantasy.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/auth.js}"></script>
</head>
<body>
    <!-- Main GNB -->
    <th:block th:replace="fragments/gnb :: #gnb"></th:block>

    <!-- Login Modal -->
    <th:block th:replace="fragments/login-modal :: #login-modal"></th:block>

    <div class="container">
        <!-- Sub GNB -->
        <div class="sub-gnb">
            <a href="/record/game" class="active">경기 조회</a>
            <a href="/record/player">선수 조회</a>
        </div>

        <!-- Search Area -->
        <div class="search-section">
            <!-- Search by Date Range -->
            <div class="search-box">
                <h3>기간별 경기 조회</h3>
                <div class="search-form">
                    <input type="date" id="startDate">
                    <span>~</span>
                    <input type="date" id="endDate">
                    <button onclick="searchByDate()">조회</button>
                </div>
            </div>

            <!-- Search by Opponent -->
            <div class="search-box">
                <h3>상대편 이름으로 조회</h3>
                <div class="search-form">
                    <input type="text" id="opponentName" placeholder="상대팀명 입력">
                    <button onclick="searchByOpponent()">조회</button>
                </div>
            </div>
        </div>

        <!-- Result Area -->
        <div id="resultArea">
            <div class="table-responsive">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>경기 일시</th>
                            <th>구장</th>
                            <th>상대팀</th>
                            <th>결과</th>
                            <th>점수 (홈:원정)</th>
                            <th>게임원 링크</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Results will be injected here -->
                    </tbody>
                </table>
            </div>
            <div id="noResults" class="no-results">검색 결과가 없습니다.</div>
        </div>
    </div>

    <script>
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return dateStr;
        }

        function formatTime(timeStr) {
            if (!timeStr) return '-';
            return timeStr; // Assuming HH:mm:ss or similar
        }

        async function searchByDate() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('시작일과 종료일을 모두 선택해주세요.');
                return;
            }

            try {
                const response = await fetch(`/apis/v1/game/list?start=${startDate}&end=${endDate}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                renderResults(data);
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }

        async function searchByOpponent() {
            const opponent = document.getElementById('opponentName').value.trim();

            if (!opponent) {
                alert('상대팀 이름을 입력해주세요.');
                return;
            }

            try {
                const response = await fetch(`/apis/v1/game/opponent/${encodeURIComponent(opponent)}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                renderResults(data);
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }

        function renderResults(data) {
            const tbody = document.querySelector('#resultTable tbody');
            const noResults = document.getElementById('noResults');
            const table = document.getElementById('resultTable');

            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                table.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            noResults.style.display = 'none';

            data.forEach(game => {
                const tr = document.createElement('tr');

                if (game.result === '승') {
                    tr.classList.add('row-win');
                } else if (game.result === '무') {
                    tr.classList.add('row-draw');
                } else if (game.result === '패') {
                    tr.classList.add('row-loss');
                }

                // Fields: Date + Time, Stadium, Opponent, Result, Score, Gameone Link
                tr.innerHTML = `
                    <td>${formatDate(game.gameDate)} ${formatTime(game.gameTime)}</td>
                    <td>${game.stadium || '-'}</td>
                    <td>${game.opponent}</td>
                    <td>${game.result || '-'}</td>
                    <td>${game.homeScore} : ${game.awayScore}</td>
                    <td><a href="${game.gameoneLink}" target="_blank">게임원 링크</a></td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
